<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Advanced Example · RetirementPlanners</title><meta name="title" content="Advanced Example · RetirementPlanners"/><meta property="og:title" content="Advanced Example · RetirementPlanners"/><meta property="twitter:title" content="Advanced Example · RetirementPlanners"/><meta name="description" content="Documentation for RetirementPlanners."/><meta property="og:description" content="Documentation for RetirementPlanners."/><meta property="twitter:description" content="Documentation for RetirementPlanners."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="https://fonts.googleapis.com/css?family=Montserrat|Source+Code+Pro&amp;display=swap" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="RetirementPlanners logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">RetirementPlanners</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox" checked/><label class="tocitem" for="menuitem-2"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../basic_example/">Basic Example</a></li><li><a class="tocitem" href="../intermediate_example/">Intermediate Example</a></li><li class="is-active"><a class="tocitem" href>Advanced Example</a><ul class="internal"><li class="toplevel"><a class="tocitem" href="#Example"><span>Example</span></a></li><li><a class="tocitem" href="#Load-Packages"><span>Load Packages</span></a></li><li><a class="tocitem" href="#Create-Model"><span>Create Model</span></a></li><li><a class="tocitem" href="#Configure-Update-Options"><span>Configure Update Options</span></a></li><li><a class="tocitem" href="#Investment-2"><span>Investment</span></a></li><li><a class="tocitem" href="#Withdraw-2"><span>Withdraw</span></a></li><li><a class="tocitem" href="#Interest-2"><span>Interest</span></a></li><li><a class="tocitem" href="#Inflation-2"><span>Inflation</span></a></li><li><a class="tocitem" href="#Run-Grid-Search"><span>Run Grid Search</span></a></li><li><a class="tocitem" href="#Survival-Analysis"><span>Survival Analysis</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../plotting/">Plotting</a></li><li><a class="tocitem" href="../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Advanced Example</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Advanced Example</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/itsdfish/RetirementPlanners.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/itsdfish/RetirementPlanners.jl/blob/main/docs/src/advanced_example.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Overview"><a class="docs-heading-anchor" href="#Overview">Overview</a><a id="Overview-1"></a><a class="docs-heading-anchor-permalink" href="#Overview" title="Permalink"></a></h1><p>The goal of the advanced example is to demonstrate how to perform more complex Monte Carlo simulations of your retirement scenario. The advanced example will cover three new techniques:</p><ol><li>simulating plausible dynamics in the stock market</li><li>creating a custom update function to include a large, one-time expense at various time points</li><li>performing the simulation across multiple values of a parameter</li></ol><p>Adding these techniques to your toolkit will allow you to simulate more plausible retirement simulations, customize the behavior of the simulation to address your own questions and goals, and systematically compare different scenarios conveniently within the same code. </p><h1 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h1><p>The advanced example builds upon the intermediate example, making three changes outlined above. </p><h2 id="Load-Packages"><a class="docs-heading-anchor" href="#Load-Packages">Load Packages</a><a id="Load-Packages-1"></a><a class="docs-heading-anchor-permalink" href="#Load-Packages" title="Permalink"></a></h2><p>The first step is to load the packages required for simulating a retirement scenario and analyzing the results. In the code block below, we will load <code>RetirementPlanners</code> to run the simulation, <code>Distributions</code> to make the simulation stochastic, and <code>StatsPlots</code> to plot the results of the simulation. </p><pre><code class="language-julia hljs">using DataFrames
using Distributions
using Random
using RetirementPlanners
using StatsPlots

Random.seed!(574)</code></pre><h2 id="Create-Model"><a class="docs-heading-anchor" href="#Create-Model">Create Model</a><a id="Create-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Create-Model" title="Permalink"></a></h2><p>The <code>Model</code> object defines the parameters and behavior of the retirement investment simulation. As in the basic example, you must enter a value for the following keyword parameters:</p><ul><li><code>Δt</code>: the time step in years </li><li><code>start_age</code>: the age of the person at the beginning of the simulation</li><li><code>duration</code>: the number of years to simulate</li><li><code>start_amount</code>: the amount of money in investments at the beginning of the simulation</li></ul><p>In this example, we will use the same timing paramers used in the basic example: we will assume you start saving for retirement at age 25 with a modest initial amount of <code>$10,000</code>. The simulation will update on a monthy basis and continue for 55 years until you reach age 80. </p><h3 id="Withdraw"><a class="docs-heading-anchor" href="#Withdraw">Withdraw</a><a id="Withdraw-1"></a><a class="docs-heading-anchor-permalink" href="#Withdraw" title="Permalink"></a></h3><p>The <code>withdraw</code> function below extends the <code>variable_withdraw</code> function from the <a href="../intermediate_example/">intermediate example</a> by allowing us to specify the amount and timing of a one-time large expense. The keyword arguments for <code>custom_withdraw</code> are defined as follows:</p><ul><li><code>start_age</code>: the age in years at which regular monthly withdraws begin </li><li><code>age_at_expense</code>: the age in years at which the one-time expense occurs</li><li><code>expense</code>: the amount of the expense in dollars </li><li><code>distribution</code>: the distribution of regular monthly withdraw amounts</li></ul><p>The function <code>custom_withdraw</code> has two basic parts based on the top-level <code>if</code> statement. The first part of the <code>if</code> statement implements the logic for the large one-time expense. The second part implements the logic for the regular monthly withdraw. Notice that the one-time expense and monthly withdraw are mutually exclusive rather than additive. Changing this logic is possible, but does not have much of an effect on the simulation results. </p><pre><code class="language-julia hljs">function custom_withdraw(
        model::AbstractModel, 
        t;
        start_age, 
        age_at_expense,
        expense,
        distribution
    )
    # make withdraw for major expense if possible
    if age_at_expense ≈ t
        model.state.withdraw_amount = expense
        if model.state.net_worth &lt; expense
            model.state.withdraw_amount = model.state.net_worth
        else
            model.state.withdraw_amount = expense
        end
    # after specified start age, with draw random amount. Otherwise, no withdraw.
    elseif start_age ≤ t 
        withdraw_amount = rand(distribution)
        if model.state.net_worth &lt; withdraw_amount
            model.state.withdraw_amount = model.state.net_worth
        else
            model.state.withdraw_amount = withdraw_amount
        end
    else 
        model.state.withdraw_amount = 0.0
    end
    return nothing
end</code></pre><h3 id="Investment"><a class="docs-heading-anchor" href="#Investment">Investment</a><a id="Investment-1"></a><a class="docs-heading-anchor-permalink" href="#Investment" title="Permalink"></a></h3><p>Following the intermediate example, we will use the <code>variable_investment</code> function to control investment behavior in the simulation. To account for fluctuations in income and expenses, <code>variable_investment</code> allows us to specify a distribution of investment amounts rather than fixed investment amount.  </p><h3 id="Interest"><a class="docs-heading-anchor" href="#Interest">Interest</a><a id="Interest-1"></a><a class="docs-heading-anchor-permalink" href="#Interest" title="Permalink"></a></h3><p>In this example, we will simulate growth the stock market using a stochastic process model called Geometric Brownian Motion (GBM). One advantage of GBM is that it provides a more accurate description of the temporal dynamics of stock market growth: the value of the stock market is noisy, but current value depends on the previous value.  Below, we will use the function <code>dynamic_interest</code> to simulate stock market growth with the GBM. </p><p>Brownian motion component of GBM is based on random movement of particles in space when no force is present to move the particles in a specific direction. Although particle physics seems disconnected from stock market behavior, it turns out to be a reasonable model because there is inherent randomness in stock prices as well as a general tendency to grow. If we add a growth rate parameter to Brownian motion and force the price to change proportially to its current value, the result is the GBM. The stochastic differential equation for the GBM is given by:</p><p><span>$X(t) = X(t)[ \mu dt + s \sqrt{dt}],$</span></p><p>where <span>$X(t)$</span> is the stock market value at time <span>$t$</span>, <span>$dt$</span> is the infintesimal time step,  <span>$\mu$</span> is the average growth rate, and <span>$s \sim \mathrm{normal}(0,\sigma)$</span> is normally distributed noise with standard deviation <span>$\sigma$</span>. The stochastic differential equation has two terms:</p><ul><li><span>$\mu dt$</span>: represents the average growth rate of the stock market. </li><li><span>$s \sqrt{dt}$</span>: represents the diffusion or <em>jitter</em> in the growth rate, which sometimes causes the price to increase or decrease more than the average growth rate. </li></ul><p>An important implication of multipling the two terms on the right hand side by <span>$X(t)$</span> is that growth and volitiliy scale with the current price, and the price cannot be negative. The code block below illustrates how to simulate and plot 10 trajectories of the GBM. The growth rate is <span>$\mu=.07$</span> with a standard deviation of <span>$\sigma=.07$</span>, indicating moderately high volitility. In the simulation, the step size is 1 day and the trajectories generated from the model span 10 years.  </p><pre><code class="language-julia hljs">gdm = GBM(; μ = .07, σ = .07)
trajectories = rand(gdm, 365 * 10, 10; Δt = 1 / 365)
plot(trajectories, leg=false, grid=false)</code></pre><img src="d40f3021.svg" alt="Example block output"/><h3 id="Inflation"><a class="docs-heading-anchor" href="#Inflation">Inflation</a><a id="Inflation-1"></a><a class="docs-heading-anchor-permalink" href="#Inflation" title="Permalink"></a></h3><p>In the example below, we will also use the GBM to simulate inflation in the economy. The primary difference will be the values assigned to the parameters <span>$\mu$</span> and <span>$\sigma$</span>. The function for using the GMB as a model of inflation is <code>dynamic_inflation</code>.</p><h3 id="Model"><a class="docs-heading-anchor" href="#Model">Model</a><a id="Model-1"></a><a class="docs-heading-anchor-permalink" href="#Model" title="Permalink"></a></h3><p>All of the assumptions described above are encoded into the model object in the code block below. </p><pre><code class="language-julia hljs">model = Model(;
    Δt = 1 / 12,
    start_age = 25,
    duration = 55,
    start_amount = 10_000,
    withdraw! = custom_withdraw,
    invest! = variable_investment,
    update_income! = variable_income,
    update_inflation! = dynamic_inflation,
    update_interest! = dynamic_interest 
)</code></pre><h2 id="Configure-Update-Options"><a class="docs-heading-anchor" href="#Configure-Update-Options">Configure Update Options</a><a id="Configure-Update-Options-1"></a><a class="docs-heading-anchor-permalink" href="#Configure-Update-Options" title="Permalink"></a></h2><p>Now that we have defined the basic components of the Monte Carlo simulation model, we will specify the parameters of the update functions. </p><h2 id="Investment-2"><a class="docs-heading-anchor" href="#Investment-2">Investment</a><a class="docs-heading-anchor-permalink" href="#Investment-2" title="Permalink"></a></h2><p>As in the <a href="../intermediate_example/">intermediate example</a>, the mean monthly investment follows a normal distribution with a mean of <code>$2,000</code> and a standard deviation of <code>$500</code> to reflect fluctuations in income and expenses. As before, investments are made until an early retirement at age 40.</p><h2 id="Withdraw-2"><a class="docs-heading-anchor" href="#Withdraw-2">Withdraw</a><a class="docs-heading-anchor-permalink" href="#Withdraw-2" title="Permalink"></a></h2><p>Upon retirement at age 40, we again assume that you withdraw <code>$2,200</code> per month with a standard deviation of <code>$500</code> to reflect fluctuation in monthly expenses. However, we assume that there is a large expense of <code>$15,000</code> at age 30 in one simulation and at age 60 in the others. To perform a grid search over these values, we wrap them in a vector as follows: <code>age_at_expense = [30,60]</code>. It is worth noting that in principle we can vary additional factors in the simulation, such as the large expense amount, or the investment distribution. For the sake of simplicity, we will only vary <em>age-at-expense</em> to observe its impact on the survival probabilities across time. </p><h2 id="Interest-2"><a class="docs-heading-anchor" href="#Interest-2">Interest</a><a class="docs-heading-anchor-permalink" href="#Interest-2" title="Permalink"></a></h2><p>Unlike the previous examples, we will use the Geometric Brownian Motion (GBM) process to simulate growth in the stock market and inflation in the monetary system. We will assume that the yearly growth rate on investments has a mean of <code>.07</code> with a standard deviation of <code>.05</code> to reflect inherent volitility in the stock market. </p><h2 id="Inflation-2"><a class="docs-heading-anchor" href="#Inflation-2">Inflation</a><a class="docs-heading-anchor-permalink" href="#Inflation-2" title="Permalink"></a></h2><p>Similarly, we will use GBM to simulate inflation in the economy. In so doing, we will assume a yearly inflation rate has a mean of <code>.035</code> and a standard deviation of <code>.005</code>. All the assumptions specified above are specified in the <code>config</code> object below. </p><pre><code class="language-julia hljs">config = (
    # invest parameters
    kw_invest = (
        distribution = Normal(2000, 500),
        end_age = 40,
    ),
    # interest parameters
    kw_interest = (
        gbm = GBM(; μ = .08, σ = .05),
    ),
    # inflation parameters
    kw_inflation = (
        gbm = GBM(; μ = .035, σ = .005),
    ),
    # withdraw parameters 
    kw_withdraw = (
        age_at_expense = [30,60],
        expense = 15_000,
        distribution = Normal(2200, 500),
        start_age = 40,
    )
)</code></pre><h2 id="Run-Grid-Search"><a class="docs-heading-anchor" href="#Run-Grid-Search">Run Grid Search</a><a id="Run-Grid-Search-1"></a><a class="docs-heading-anchor-permalink" href="#Run-Grid-Search" title="Permalink"></a></h2><p>In the code block below, we will perform a grid search over the values for <em>age-at-expense</em> to see how it affects the survival probability of the retirement plan across time. As its name implies, this is performed with the function <code>grid_search</code> which takes as input the <code>model</code> object, the <code>Logger</code> object type, <code>n_reps</code>, and our simulation configuration object, <code>config</code>. Internally, <code>grid_search</code> calls <code>simulate!</code> for each value of <em>age-at-expense</em>. The second line in the code block converts the results to a <code>DataFrame</code> to make subsequent analysis and plotting easier. </p><pre><code class="language-julia hljs"># perform the grid search for age_at_expense using 10_000 reps per condition
results = grid_search(model, Logger, 10_000; config)
# convert output to data frame
df = to_dataframe(model, results)</code></pre><pre><code class="language-julia hljs">13200000×6 DataFrame
      Row │ time     rep    net_worth      interest     inflation  withdraw_age_at_expense 
          │ Float64  Int64  Float64        Float64      Float64    Int64                   
──────────┼────────────────────────────────────────────────────────────────────────────────
        1 │ 25.0833      1  12839.3         0.168697    0.0256016                       30
        2 │ 25.1667      1  14376.0        -0.0600889   0.0395033                       30
        3 │ 25.25        1  16297.6        -0.244519    0.0583386                       30
        4 │ 25.3333      1  18628.6         0.160349    0.0499842                       30
        5 │ 25.4167      1  20787.8         0.0607486   0.0499415                       30
    ⋮     │    ⋮       ⋮          ⋮             ⋮           ⋮                 ⋮
 13199997 │ 79.75    10000      6.48052e5  -0.189062    0.0411538                       60
 13199998 │ 79.8333  10000      6.43572e5   0.00590992  0.044513                        60
 13199999 │ 79.9167  10000      6.36921e5  -0.00792474  0.075874                        60
 13200000 │ 80.0     10000      6.36214e5   0.0840805   0.0522622                       60
                                                                      13199991 rows omitted</code></pre><h2 id="Survival-Analysis"><a class="docs-heading-anchor" href="#Survival-Analysis">Survival Analysis</a><a id="Survival-Analysis-1"></a><a class="docs-heading-anchor-permalink" href="#Survival-Analysis" title="Permalink"></a></h2><p>In this section, we will perform a survival analysis to determine the probability that the retirement plan will be successful (i.e., net worth &gt; 0) as a function of time. The first step is to create a new indicator variable in the dataframe called <code>survived</code>, which is true if the net worth at time <span>$t$</span> is greater than zero, and is false otherwise. The subsequent line groups the dataframe according to the factors <em>age-at-expense</em> and <em>time</em> and computes the mean of each combination across all repetitions.  </p><pre><code class="language-julia hljs"># code surival at each time point as true or false
df.survived = df.net_worth .&gt; 0
# compute the surival probability as a function of age at expense and time
df_survival = combine(groupby(df, [:withdraw_age_at_expense,:time]), :survived =&gt; mean =&gt; :survival_prob)</code></pre><pre><code class="language-julia hljs">1320×3 DataFrame
  Row │ withdraw_age_at_expense  time     survival_prob 
      │ Int64                    Float64  Float64       
──────┼─────────────────────────────────────────────────
    1 │                      30  25.0833         1.0
    2 │                      30  25.1667         1.0
    3 │                      30  25.25           1.0
    4 │                      30  25.3333         1.0
    5 │                      30  25.4167         1.0
  ⋮   │            ⋮                ⋮           ⋮
 1317 │                      60  79.75           0.5792
 1318 │                      60  79.8333         0.577
 1319 │                      60  79.9167         0.5754
 1320 │                      60  80.0            0.5739
                                       1311 rows omitted</code></pre><p>The code block below generates a plot of the survival probability as a function of time for each level of <em>age-at-expse</em>. As the plot shows, incurring the expense at age 30 reduces the surival probability compared to incurring the cost at age 60. As time continues, the difference in survival probability between the two levels increases. The primary reason is because early withdraw incurrs a larger opportunity cost for compounding interest. In this particular case, the impact was small to moderate, but the effect would be larger with a larger expense. </p><pre><code class="language-julia hljs">@df df_survival plot(:time, :survival_prob, group=:withdraw_age_at_expense,
    ylims=(0,1), legendtitle=&quot;Age at Expense&quot;, grid=false, xlabel=&quot;Age&quot;, 
    ylabel=&quot;Survival Probability&quot;, legend=:bottomleft)</code></pre><p><img src="../assets/survival_advanced_example.png" alt/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../intermediate_example/">« Intermediate Example</a><a class="docs-footer-nextpage" href="../plotting/">Plotting »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.3.0 on <span class="colophon-date" title="Sunday 24 March 2024 21:04">Sunday 24 March 2024</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
