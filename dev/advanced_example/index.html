<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Advanced Example · RetirementPlanners</title><meta name="title" content="Advanced Example · RetirementPlanners"/><meta property="og:title" content="Advanced Example · RetirementPlanners"/><meta property="twitter:title" content="Advanced Example · RetirementPlanners"/><meta name="description" content="Documentation for RetirementPlanners."/><meta property="og:description" content="Documentation for RetirementPlanners."/><meta property="twitter:description" content="Documentation for RetirementPlanners."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="https://fonts.googleapis.com/css?family=Montserrat|Source+Code+Pro&amp;display=swap" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">RetirementPlanners</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox" checked/><label class="tocitem" for="menuitem-2"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../basic_example/">Basic Example</a></li><li><a class="tocitem" href="../intermediate_example/">Intermediate Example</a></li><li class="is-active"><a class="tocitem" href>Advanced Example</a><ul class="internal"><li class="toplevel"><a class="tocitem" href="#Example"><span>Example</span></a></li><li><a class="tocitem" href="#Load-Packages"><span>Load Packages</span></a></li><li><a class="tocitem" href="#Create-Model"><span>Create Model</span></a></li><li><a class="tocitem" href="#Configure-Update-Options"><span>Configure Update Options</span></a></li><li><a class="tocitem" href="#Run-Simulation"><span>Run Simulation</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../plotting/">Plotting</a></li><li><a class="tocitem" href="../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Advanced Example</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Advanced Example</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/itsdfish/RetirementPlanners.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/itsdfish/RetirementPlanners.jl/blob/main/docs/src/advanced_example.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Overview"><a class="docs-heading-anchor" href="#Overview">Overview</a><a id="Overview-1"></a><a class="docs-heading-anchor-permalink" href="#Overview" title="Permalink"></a></h1><p>The goal of the advanced example is to demonstrate how to perform more complex Monte Carlo simulations of your retirement scenario. The advanced example will cover three new techniques:</p><ol><li>simulating plausible dynamics in the stock market</li><li>creating a custom update function for withdrawing money from investments</li><li>performing the simulation across multiple values of a parameter</li></ol><p>Adding these techniques to your toolkit will allow you to simulate more plausible retirement simulations, customize the behavior of the simulation to address your own questions and goals, and systematically compare different scenarios conveniently within the same code. </p><h1 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h1><p>The advanced example builds upon the intermediate example, making three changes outlined above. </p><h2 id="Load-Packages"><a class="docs-heading-anchor" href="#Load-Packages">Load Packages</a><a id="Load-Packages-1"></a><a class="docs-heading-anchor-permalink" href="#Load-Packages" title="Permalink"></a></h2><p>The first step is to load the packages required for simulating a retirement scenario and analyzing the results. In the code block below, we will load <code>RetirementPlanners</code> to run the simulation, <code>Distributions</code> to make the simulation stochastic, and <code>StatsPlots</code> to plot the results of the simulation. </p><pre><code class="language-julia hljs">using DataFrames
using Distributions
using Random
using RetirementPlanners
using StatsPlots

Random.seed!(574)</code></pre><h2 id="Create-Model"><a class="docs-heading-anchor" href="#Create-Model">Create Model</a><a id="Create-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Create-Model" title="Permalink"></a></h2><p>The <code>Model</code> object defines the parameters and behavior of the retirement investment simulation. As in the basic example, you must enter a value for the following keyword parameters:</p><ul><li><code>Δt</code>: the time step in years </li><li><code>start_age</code>: the age of the person at the beginning of the simulation</li><li><code>duration</code>: the number of years to simulate</li><li><code>start_amount</code>: the amount of money in investments at the beginning of the simulation</li></ul><p>In this example, we will use the same timing paramers used in the basic example: we will assume you start saving for retirement at age 25 with a modest initial amount of <code>$</code>10,000. The simulation will update on a monthy basis and continue for 55 years until you reach age 80. </p><h3 id="Withdraw"><a class="docs-heading-anchor" href="#Withdraw">Withdraw</a><a id="Withdraw-1"></a><a class="docs-heading-anchor-permalink" href="#Withdraw" title="Permalink"></a></h3><pre><code class="language-julia hljs">function custom_withdraw(
        model::AbstractModel, 
        t;
        start_age, 
        age_at_expense,
        expense,
        distribution
    )
    # make withdraw for major expense if possible
    if age_at_expense == t
        model.state.withdraw_amount = expense
        if model.state.net_worth &lt; expense
            model.state.withdraw_amount = model.state.net_worth
        else
            model.state.withdraw_amount = expense
        end
    # after specified start age, with draw random amount. Otherwise, no withdraw.
    elseif start_age ≤ t 
        withdraw_amount = rand(distribution)
        if model.state.net_worth &lt; withdraw_amount
            model.state.withdraw_amount = model.state.net_worth
        else
            model.state.withdraw_amount = withdraw_amount
        end
    else 
        model.state.withdraw_amount = 0.0
    end
    return nothing
end</code></pre><h3 id="Investment"><a class="docs-heading-anchor" href="#Investment">Investment</a><a id="Investment-1"></a><a class="docs-heading-anchor-permalink" href="#Investment" title="Permalink"></a></h3><p>Following the intermediate example, we will use the <code>variable_investment</code> function to control investment behavior in the simulation. To account for fluctuations in income and expenses, <code>variable_investment</code> allows us to specify a distribution of investment amounts rather than fixed investment amount.  </p><h3 id="Interest"><a class="docs-heading-anchor" href="#Interest">Interest</a><a id="Interest-1"></a><a class="docs-heading-anchor-permalink" href="#Interest" title="Permalink"></a></h3><p>In this example, we will simulate growth the stock market using a stochastic process model called Geometric Brownian Motion (GBM). Brownian motion describes random movement of particles in space when no force is present to move the particles in a specific direction. Although this seems disconnected from stock market behavior, it turns out to be a reasonable model because there is inherent randomness in stock prices as well as a general tendency to grow. If we add a growth rate parameter to Brownian motion and force the price to change proportially to its current value, the result is the GBM. The stochastic differential equation for the GBM is given by:</p><p><span>$X(t) = X(t)[ \mu dt + s \sqrt{dt}],$</span></p><p>where <span>$X(t)$</span> is the stock market value at time <span>$t$</span>, <span>$dt$</span> is the infintesimal time step,  <span>$\mu$</span> is the average growth rate, and <span>$s \sim \mathrm{normal}(0,\sigma)$</span> is normally distributed noise with standard deviation <span>$\sigma$</span>. The first term <span>$\mu dt$</span> represents the average growth rate of the stock market. The second term <span>$s \sqrt{dt}$</span> represents the diffusion or <em>jitter</em> in the growth rate, which sometimes causes the price to increase or decrease more than the average growth rate. An important implication of multipling the two terms on the right hand side by <span>$X(t)$</span> is that growth and volitiliy scale with the current price, and the price cannot be negative.  </p><p>The code block below illustrates how to simulate and plot 10 trajectories of the GBM. The growth rate is <span>$\mu=.07$</span> with a standard deviation of <span>$\sigma=.07$</span>, indicating moderately high volitility. In the simulation, the step size is 1 day and the trajectories generated from the model span 10 years.  </p><pre><code class="language- hljs">gdm = GBM(; μ = .07, σ = .07)
trajectories = rand(gdm, 365 * 10, 10; Δt = 1 / 365)
plot(trajectories, leg=false, grid=false)</code></pre><h3 id="Inflation"><a class="docs-heading-anchor" href="#Inflation">Inflation</a><a id="Inflation-1"></a><a class="docs-heading-anchor-permalink" href="#Inflation" title="Permalink"></a></h3><p>In the example below, we will also use the GBM to simulate inflation in the economy. The primary difference will be the values assigned to the parameters <span>$\mu$</span> and <span>$\sigma$</span>. </p><h3 id="Model"><a class="docs-heading-anchor" href="#Model">Model</a><a id="Model-1"></a><a class="docs-heading-anchor-permalink" href="#Model" title="Permalink"></a></h3><pre><code class="language-julia hljs">model = Model(;
    Δt = 1 / 12,
    start_age = 25,
    duration = 55,
    start_amount = 10_000,
    withdraw! = custom_withdraw,
    invest! = variable_investment,
    update_income! = variable_income,
    update_inflation! = dynamic_inflation,
    update_interest! = dynamic_interest 
)</code></pre><h2 id="Configure-Update-Options"><a class="docs-heading-anchor" href="#Configure-Update-Options">Configure Update Options</a><a id="Configure-Update-Options-1"></a><a class="docs-heading-anchor-permalink" href="#Configure-Update-Options" title="Permalink"></a></h2><p>We will specify the parameters of the update function in a nested configuration data structure, which passes keyword arguments to their corresponding update funtions. The configuration data structure is a nested <code>NamedTuple</code> (i.e., immutable keyword-value pairs), where the keywords in the first level correspond to the keyword inputs of the update functions. For example, the keyword <code>kw_invest</code> (short for keyword invest) is a set of keywords passed to the function <code>fixed_investment</code>.</p><p>The configuration data structure below defines distributions over quanties, such as investment and withdraw amount. Aside from drawling random values from probability distributions, the simulation is the same as that described in the <a href="../basic_example/">basic example</a>.</p><p>The mean monthly investment follows a normal distribution with a mean of <code>$2,000</code> and a standard deviation of <code>$500</code> to reflect fluctuations in income and expenses. As before, investments are made until an early retirement at age 40. The yearly interest rate on investments has a mean of <code>.08</code> with a large standard deviation of <code>.08</code> to reflect inherent volitility in the stock market. The yearly inflation rate has a mean of <code>.035</code> and a standard deviation of <code>.015</code>. Upon retirement at age 40, we assume that you withdraw <code>$2,200</code> per month with a standard deviation of <code>$500</code> to reflect fluctuation in monthly expenses. </p><pre><code class="language-julia hljs">config = (
    # invest parameters
    kw_invest = (
        distribution = Normal(2000, 500),
        end_age = 40,
    ),
    # interest parameters
    kw_interest = (
        gbm = GBM(; μ = .07, σ = .05),
    ),
    # inflation parameters
    kw_inflation = (
        gbm = GBM(; μ = .035, σ = .005),
    ),
    # withdraw parameters 
    kw_withdraw = (
        age_at_expense = [30,60],
        expense = 15_000,
        distribution = Normal(2200, 500),
        start_age = 40,
    )
)</code></pre><h2 id="Run-Simulation"><a class="docs-heading-anchor" href="#Run-Simulation">Run Simulation</a><a id="Run-Simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Run-Simulation" title="Permalink"></a></h2><p>Now that we have specified the parameters of the simulation, we can use the function <code>simulate!</code> to generate retirement numbers and save them to the <code>Logger</code> object. As shown below, <code>simulate!</code> requires our model object, the logger, and the number of repetitions. The optional configuration object is passed as a variable keyword using <code>; config...</code>, which maps the nested keywords in the <code>NamedTuple</code> to the corresponding keywords defined in the <code>simulate!</code> method signature. </p><pre><code class="language-julia hljs"># perform the grid search for age_at_expense using 5000 reps per condition
results = grid_search(model, Logger, 10_000; config)
# convert output to data frame
df = to_dataframe(model, results)</code></pre><pre><code class="language-julia hljs"># code surival at each time point as true or false
df.survived = df.net_worth .&gt; 0
# compute the surival probability as a function of age at expense and time
df_survival = combine(groupby(df, [:withdraw_age_at_expense,:time]), :survived =&gt; mean =&gt; :survival_prob)</code></pre><p>The code block below plots five simulation runs. As you can see, there is marked variability between the simulation runs, particularly during the retirement phase following peak net worth. </p><pre><code class="language-julia hljs">@df df_survival plot(:time, :survival_prob, group=:withdraw_age_at_expense,
    ylims=(0,1), legendtitle=&quot;Age at Expense&quot;, grid=false, xlabel=&quot;Age&quot;, ylabel=&quot;Survival Probability&quot;, legend=:bottomleft)</code></pre><p><img src="../assets/survival_advanced_example.png" alt/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../intermediate_example/">« Intermediate Example</a><a class="docs-footer-nextpage" href="../plotting/">Plotting »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Saturday 27 January 2024 14:58">Saturday 27 January 2024</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
