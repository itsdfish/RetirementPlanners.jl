<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Intermediate Example · RetirementPlanners</title><meta name="title" content="Intermediate Example · RetirementPlanners"/><meta property="og:title" content="Intermediate Example · RetirementPlanners"/><meta property="twitter:title" content="Intermediate Example · RetirementPlanners"/><meta name="description" content="Documentation for RetirementPlanners."/><meta property="og:description" content="Documentation for RetirementPlanners."/><meta property="twitter:description" content="Documentation for RetirementPlanners."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="https://fonts.googleapis.com/css?family=Montserrat|Source+Code+Pro&amp;display=swap" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="RetirementPlanners logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">RetirementPlanners</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox" checked/><label class="tocitem" for="menuitem-2"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../basic_example/">Basic Example</a></li><li class="is-active"><a class="tocitem" href>Intermediate Example</a><ul class="internal"><li class="toplevel"><a class="tocitem" href="#Example"><span>Example</span></a></li><li><a class="tocitem" href="#Load-Packages"><span>Load Packages</span></a></li><li><a class="tocitem" href="#Create-Model"><span>Create Model</span></a></li><li><a class="tocitem" href="#Configure-Update-Options"><span>Configure Update Options</span></a></li><li><a class="tocitem" href="#Setup-Logger"><span>Setup Logger</span></a></li><li><a class="tocitem" href="#Run-Simulation"><span>Run Simulation</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../plotting/">Plotting</a></li><li><a class="tocitem" href="../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Intermediate Example</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Intermediate Example</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/itsdfish/RetirementCalculators.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/itsdfish/RetirementCalculators.jl/blob/main/docs/src/intermediate_example.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Overview"><a class="docs-heading-anchor" href="#Overview">Overview</a><a id="Overview-1"></a><a class="docs-heading-anchor-permalink" href="#Overview" title="Permalink"></a></h1><p>This example builds upon the <a href="../basic_example/">basic example</a> and attempts to overcome some of its limitations. The primary limitation with the basic example is that it lacked the means to capture uncertainy in future events, such as interest rates, and the amount withdrawn from investments during retirement. To capture the inherent uncertainty of future events, we will sample these quantities from specified distributions. In so doing, we will be able to stress test the retirement plan under a wide variety of uncertain scenarios to determine the survival probability as a function of time. This will allow us to answer questions, such as <em>what is the chance of running out of money after 20 years?</em></p><h1 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h1><h2 id="Load-Packages"><a class="docs-heading-anchor" href="#Load-Packages">Load Packages</a><a id="Load-Packages-1"></a><a class="docs-heading-anchor-permalink" href="#Load-Packages" title="Permalink"></a></h2><p>The first step is to load the packages required for simulating a retirement scenario and analyzing the results. In the code block below, we will load <code>RetirementPlanners</code> to run the simulation, <code>Distributions</code> to make the simulation stochastic, and <code>Plots</code> to plot the results of the simulation. </p><pre><code class="language-julia hljs">using Distributions
using Plots
using RetirementPlanners</code></pre><h2 id="Create-Model"><a class="docs-heading-anchor" href="#Create-Model">Create Model</a><a id="Create-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Create-Model" title="Permalink"></a></h2><p>We will illustrate how to setup and run a simulation with a simple example. Let&#39;s assume that you are 27 years old with an initial investment <code>of $10,000</code>, and you invest <code>$625</code> each month until early retirement at age 60. Assume further that the yearly interest rate on investments is <code>.08</code>, which is inflation adjusted by a yearly rate of <code>.035</code>. Upon reaching 60 years old, we will assume you will draw <code>$2,200</code> per month.  The simulation will update on a monthy basis and continue for 58 years until you reach age 85. For this simple example, we will use the following functions:</p><p>The function names are prefixed with <code>variable</code> to signify that they allow us to introduce variability in the simulation behavior by sampling relevant quantities from distributions specified by the user. The distribution can be any univariate distribution defined in <a href="https://juliastats.org/Distributions.jl/stable/">Distributions.jl</a>. In cases where the desired distribution is not available in <code>Distributions.jl</code>, you may use their API to create custom distribution types. You can find more details on these update functions in the <a href="../api/">API</a> or by typing <code>? function_name</code> in the the REPL. </p><h2 id="Configure-Update-Options"><a class="docs-heading-anchor" href="#Configure-Update-Options">Configure Update Options</a><a id="Configure-Update-Options-1"></a><a class="docs-heading-anchor-permalink" href="#Configure-Update-Options" title="Permalink"></a></h2><p>We will specify the parameters of the update function in a nested configuration data structure, which passes keyword arguments to their corresponding update funtions. The configuration data structure is a nested <code>NamedTuple</code> (i.e., immutable keyword-value pairs), where the keywords in the first level correspond to the keyword inputs of the update functions. For example, the keyword <code>kw_invest</code> (short for keyword invest) is a set of keywords passed to the function <code>fixed_investment</code>.</p><p>The configuration data structure below defines distributions over quanties, such as investment and withdraw amount. Aside from drawling random values from probability distributions, the simulation is the same as that described in the <a href="../basic_example/">basic example</a>.</p><p>The mean monthly investment follows a normal distribution with a mean of <code>$2,000</code> and a standard deviation of <code>$500</code> to reflect fluctuations in income and expenses. As before, investments are made until an early retirement at age 40. The yearly interest rate on investments has a mean of <code>.08</code> with a large standard deviation of <code>.08</code> to reflect inherent volitility in the stock market. The yearly inflation rate has a mean of <code>.035</code> and a standard deviation of <code>.015</code>. Upon retirement at age 40, we assume that you withdraw <code>$2,200</code> per month with a standard deviation of <code>$500</code> to reflect fluctuation in monthly expenses. </p><h3 id="Interest"><a class="docs-heading-anchor" href="#Interest">Interest</a><a id="Interest-1"></a><a class="docs-heading-anchor-permalink" href="#Interest" title="Permalink"></a></h3><p>In this example, we will simulate growth the stock market using a stochastic process model called Geometric Brownian Motion (GBM). One advantage of GBM is that it provides a more accurate description of the temporal dynamics of stock market growth: the value of the stock market is noisy, but current value depends on the previous value.  Below, we will use the function <code>dynamic_interest</code> to simulate stock market growth with the GBM. </p><details>
<summary><b>Show Details</b></summary><p>Brownian motion component of GBM is based on random movement of particles in space when no force is present to move the particles in a specific direction. Although particle physics seems disconnected from stock market behavior, it turns out to be a reasonable model because there is inherent randomness in stock prices as well as a general tendency to grow. If we add a growth rate parameter to Brownian motion and force the price to change proportially to its current value, the result is the GBM. The stochastic differential equation for the GBM is given by:</p><p><span>$X(t) = X(t)[ \mu dt + s \sqrt{dt}],$</span></p><p>where <span>$X(t)$</span> is the stock market value at time <span>$t$</span>, <span>$dt$</span> is the infintesimal time step,  <span>$\mu$</span> is the average growth rate, and <span>$s \sim \mathrm{normal}(0,\sigma)$</span> is normally distributed noise with standard deviation <span>$\sigma$</span>. The stochastic differential equation has two terms:</p><ul><li><span>$\mu dt$</span>: represents the average growth rate of the stock market. </li><li><span>$s \sqrt{dt}$</span>: represents the diffusion or <em>jitter</em> in the growth rate, which sometimes causes the price to increase or decrease more than the average growth rate. </li></ul><p>An important implication of multipling the two terms on the right hand side by <span>$X(t)$</span> is that growth and volitiliy scale with the current price, and the price cannot be negative. The code block below illustrates how to simulate and plot 10 trajectories of the GBM. The growth rate is <span>$\mu=.07$</span> with a standard deviation of <span>$\sigma=.07$</span>, indicating moderately high volitility. </p></details><p>In the simulation, the step size is 1 day and the trajectories generated from the model span 10 years.  </p><pre><code class="language- hljs">gdm = GBM(; μ = .07, σ = .07)
trajectories = rand(gdm, 365 * 10, 10; Δt = 1 / 365)
plot(trajectories, leg=false, grid=false)</code></pre><pre><code class="language-julia hljs">config = (
    # time step in years
    Δt = 1 / 12,
    # start age of simulation
    start_age = 27,
    # duration of simulation in years
    duration = 58,
    # initial investment amount
    start_amount = 10_000,
    # function for adaptive withdraw
    withdraw! = adaptive_withdraw,
    # withdraw parameters
    kw_withdraw = (
        start_age = 60.0,
        income_adjustment = 0,
        min_withdraw = 2000,
        percent_of_real_growth = 0.15,
        volitility = 0.05,
        lump_sum_withdraws = Dict(-1 =&gt; 100)
    ),
    # invest parameters
    kw_invest = (distribution = Normal(625, 100), end_age = 60),
    # interest parameters
    kw_interest = (gbm = VarGBM(; αμ = 0.07, ημ = 0.005, ασ = 0.025, ησ = 0.010),),
    # inflation parameters
    kw_inflation = (gbm = VarGBM(; αμ = 0.035, ημ = 0.005, ασ = 0.005, ησ = 0.0025),),
    # income parameters
    kw_income = (social_security_income = 1300, social_security_start_age = 67)
)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(Δt = 0.08333333333333333, start_age = 27, duration = 58, start_amount = 10000, withdraw! = RetirementPlanners.adaptive_withdraw, kw_withdraw = (start_age = 60.0, income_adjustment = 0, min_withdraw = 2000, percent_of_real_growth = 0.15, volitility = 0.05, lump_sum_withdraws = Dict(-1 =&gt; 100)), kw_invest = (distribution = Normal{Float64}(μ=625.0, σ=100.0), end_age = 60), kw_interest = (gbm = VarGBM{Float64}(μ=0.0, σ=0.0, αμ=0.07, ασ=0.025, ημ=0.005, ησ=0.01, x0=0.005, x=0.01),), kw_inflation = (gbm = VarGBM{Float64}(μ=0.0, σ=0.0, αμ=0.035, ασ=0.005, ημ=0.005, ησ=0.0025, x0=0.005, x=0.0025),), kw_income = (social_security_income = 1300, social_security_start_age = 67))</code></pre><pre><code class="language-julia hljs">model = Model(; config...)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"><span class="sgr1">Model</span>
┌───────────────────┬───────────────────────────────────────────────────────────
│<span class="sgr1"> Field             </span>│<span class="sgr1"> Value                                                   </span> ⋯
├───────────────────┼───────────────────────────────────────────────────────────
│<span class="sgr1"> Δt                </span>│  0.08                                                    ⋯
│<span class="sgr1"> duration          </span>│ 58.00                                                    ⋯
│<span class="sgr1"> start_age         </span>│ 27.00                                                    ⋯
│<span class="sgr1"> start_amount      </span>│ 10000.00                                                 ⋯
│<span class="sgr1"> state             </span>│ State{Float64}(0.0, 0.0, 0.0, 0.0, 0.0, 0.0)             ⋯
│<span class="sgr1"> withdraw!         </span>│ adaptive_withdraw                                        ⋯
│<span class="sgr1"> invest!           </span>│ variable_invest                                          ⋯
│<span class="sgr1"> update_income!    </span>│ fixed_income                                             ⋯
│<span class="sgr1"> update_inflation! </span>│ dynamic_inflation                                        ⋯
│<span class="sgr1"> update_interest!  </span>│ dynamic_interest                                         ⋯
│<span class="sgr1"> update_net_worth! </span>│ default_net_worth                                        ⋯
│<span class="sgr1"> log!              </span>│ default_log!                                             ⋯
│<span class="sgr1"> config            </span>│ (kw_withdraw = (start_age = 60.0, income_adjustment = 0, ⋯
└───────────────────┴───────────────────────────────────────────────────────────
<span class="sgr36">                                                                1 column omitted</span>
</code></pre><h2 id="Setup-Logger"><a class="docs-heading-anchor" href="#Setup-Logger">Setup Logger</a><a id="Setup-Logger-1"></a><a class="docs-heading-anchor-permalink" href="#Setup-Logger" title="Permalink"></a></h2><p>The next step is to initialize the data logger. On each time step, the data logger stores the following quantities: annualized interest rate, annualized inflation rate, and net worth. The <code>Logger</code> object requires two inputs: <code>n_steps</code>: the total number of time steps in one simulation, and <code>n_reps</code>: the total repetitions of the simulation. The total number of time steps can be found by getting the length of the time steps. In this simple scenario, we will repeat the simulation <code>10,000</code> times to provide a stable estimate of the variability in the investment and retirement conditions. </p><pre><code class="language-julia hljs">times = get_times(model)
n_reps = 1000
n_steps = length(times)
logger = Logger(; n_steps, n_reps)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"><span class="sgr1">Logger</span>
┌──────────────┬────────────────────────────────────────────────────────────────
│<span class="sgr1"> Field        </span>│<span class="sgr1"> Value                                                        </span> ⋯
├──────────────┼────────────────────────────────────────────────────────────────
│<span class="sgr1"> net_worth    </span>│ [0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; ⋯
│<span class="sgr1"> interest     </span>│ [0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; ⋯
│<span class="sgr1"> inflation    </span>│ [0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; ⋯
│<span class="sgr1"> total_income </span>│ [0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; ⋯
└──────────────┴────────────────────────────────────────────────────────────────
<span class="sgr36">                                                                1 column omitted</span>
</code></pre><h2 id="Run-Simulation"><a class="docs-heading-anchor" href="#Run-Simulation">Run Simulation</a><a id="Run-Simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Run-Simulation" title="Permalink"></a></h2><p>Now that we have specified the parameters of the simulation, we can use the function <code>simulate!</code> to generate retirement numbers and save them to the <code>Logger</code> object. As shown below, <code>simulate!</code> requires our model object, the logger, and the number of repetitions. The optional configuration object is passed as a variable keyword using <code>; config...</code>, which maps the nested keywords in the <code>NamedTuple</code> to the corresponding keywords defined in the <code>simulate!</code> method signature. </p><pre><code class="language-julia hljs">simulate!(model, logger, n_reps)</code></pre><p>One of the biggest changes from the basic example is the use of random values for withdraw and interest. In the code block below, we will use the function <code>plot_gradient</code> to represent variability in networth projections. Darker values correspond to higher density or more likely trajectories.   </p><pre><code class="language-julia hljs"># plot of survival probability as a function of time
survival_probs = mean(logger.net_worth .&gt; 0, dims = 2)
survival_plot = plot(
    times,
    survival_probs,
    leg = false,
    xlabel = &quot;Age&quot;,
    grid = false,
    ylabel = &quot;Survival Probability&quot;,
    xlims = (config.kw_withdraw.start_age, times[end]),
    ylims = (0.5, 1.05),
    color = :black
)

# networth as a function of time. Darker shading indicates more likely values
net_worth_plot = plot_gradient(
    times,
    logger.net_worth;
    xlabel = &quot;Age&quot;,
    ylabel = &quot;Net Worth&quot;,
    n_lines = 0,
)

# growth rate distribution across repetitions of the simulation
growth = logger.interest[:]
interest_plot = histogram(
    growth,
    norm = true,
    xlabel = &quot;Market Growth&quot;,
    ylabel = &quot;Density&quot;,
    color = RGB(148 / 255, 173 / 255, 144 / 255),
    bins = 100,
    label = false,
    grid = false,
    xlims = (-0.7, 0.7)
)
vline!(
    interest_plot,
    [0.0],
    color = :black,
    linewidth = 1.5,
    linestyle = :dash,
    label = false
)

# income as a function of time.
income_plot = plot_gradient(
    times,
    logger.total_income;
    xlabel = &quot;Age&quot;,
    ylabel = &quot;Total Income&quot;,
    xlims = (config.kw_withdraw.start_age, times[end]),
    n_lines = 0,
    color = :blue
)
plot(survival_plot, net_worth_plot, interest_plot, income_plot, layout = (2, 2))</code></pre><img src="3b167f41.svg" alt="Example block output"/></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../basic_example/">« Basic Example</a><a class="docs-footer-nextpage" href="../plotting/">Plotting »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.4.0 on <span class="colophon-date" title="Sunday 21 April 2024 07:32">Sunday 21 April 2024</span>. Using Julia version 1.10.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
